<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>üßë‚Äçüç≥ Test API /create/recipe</title>
<style>
  body { font-family: sans-serif; margin: 20px; background: #f6f6f6; }
  h2 { color: #333; }
  form { display: flex; flex-direction: column; gap: 10px; max-width: 700px; }
  label { font-weight: bold; margin-top: 8px; }
  textarea, input, select { padding: 6px; font-size: 14px; border-radius: 4px; border: 1px solid #ccc; }
  button { padding: 8px 14px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
  button:hover { background: #0056b3; }
  .result { white-space: pre-wrap; background: #eee; padding: 10px; margin-top: 15px; border-radius: 5px; }
  .group { background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; }
  .small-btn { background: #dc3545; padding: 4px 8px; font-size: 12px; border-radius: 3px; margin-left: 5px; }
  .small-btn:hover { background: #c82333; }
  .add-btn { background: #28a745; font-size: 13px; margin-top: 5px; }
  .add-btn:hover { background: #218838; }
  img.preview { max-width: 150px; margin-top: 5px; border-radius: 6px; display: block; }
</style>
</head>
<body>

<h2>üßë‚Äçüç≥ Test API: /create/recipe</h2>

<label>JWT Token:</label>
<input type="text" id="jwt" placeholder="D√°n token JWT c·ªßa b·∫°n v√†o ƒë√¢y" />

<form id="recipeForm">
  <label>Title:</label>
  <input name="title" value="B√°nh tr·ª©ng n∆∞·ªõng ph√¥ mai" required />

  <label>Description:</label>
  <textarea name="description">M√≥n b√°nh tr·ª©ng m·ªÅm m·ªãn, b√©o ng·∫≠y th∆°m m√πi ph√¥ mai.</textarea>

  <label>Servings:</label>
  <input name="servings" type="number" value="4" required />

  <label>Prep Time (ph√∫t):</label>
  <input name="prepTime" type="number" value="15" required />

  <label>Cook Time (ph√∫t):</label>
  <input name="cookTime" type="number" value="25" required />

  <label>Difficulty:</label>
  <select name="difficulty">
    <option>VERY_EASY</option>
    <option selected>EASY</option>
    <option>MEDIUM</option>
  </select>

  <label>Scope:</label>
  <select name="scope">
    <option selected>PUBLIC</option>
    <option>PRIVATE</option>
    <option>DRAFT</option>
  </select>

  <label>·∫¢nh ƒë·∫°i di·ªán:</label>
  <input name="image" type="file" accept="image/*" onchange="previewImage(this, '#mainPreview')" />
  <img id="mainPreview" class="preview" style="display:none" />

  <hr>
  <h3>Steps</h3>
  <div id="stepsContainer"></div>
  <button type="button" class="add-btn" onclick="addStep()">+ Th√™m Step</button>

  <hr>
  <h3>Ingredients</h3>
  <div id="ingredientsContainer"></div>
  <button type="button" class="add-btn" onclick="addIngredient()">+ Th√™m Ingredient</button>

  <hr>
  <h3>Category IDs</h3>
  <div id="categoriesContainer">
    <input type="number" class="categoryId" value="1" placeholder="Category ID" /> 
  </div>
  <button type="button" class="add-btn" onclick="addCategory()">+ Th√™m Category</button>

  <h3>Tag IDs</h3>
  <div id="tagsContainer">
    <input type="number" class="tagId" value="2" placeholder="Tag ID" /> 
  </div>
  <button type="button" class="add-btn" onclick="addTag()">+ Th√™m Tag</button>

  <hr>
  <button type="submit">üöÄ G·ª≠i API</button>
</form>

<div class="result" id="result"></div>

<script>
let stepCount = 0;

// Hi·ªÉn th·ªã ·∫£nh preview
function previewImage(input, targetSelector) {
  const file = input.files[0];
  const img = document.querySelector(targetSelector);
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      img.src = e.target.result;
      img.style.display = 'block';
    };
    reader.readAsDataURL(file);
  } else {
    img.style.display = 'none';
  }
}

function addStep() {
  const c = document.getElementById('stepsContainer');
  const d = document.createElement('div');
  d.className = 'group';
  const idx = ++stepCount;
  d.innerHTML = `
    <label>Step #${idx}</label>
    <input type="number" placeholder="stepNumber" class="stepNumber" value="${idx}" required />
    <textarea placeholder="Description" class="stepDesc" required>B∆∞·ªõc ${idx}: M√¥ t·∫£...</textarea>
    <input type="file" multiple class="stepImages" accept="image/*" onchange="showStepPreviews(this)" />
    <div class="stepPreview"></div>
    <button type="button" class="small-btn" onclick="this.parentElement.remove()">X√≥a</button>
  `;
  c.appendChild(d);
}

function showStepPreviews(input) {
  const container = input.nextElementSibling;
  container.innerHTML = '';
  for (let f of input.files) {
    const reader = new FileReader();
    reader.onload = e => {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.className = 'preview';
      container.appendChild(img);
    };
    reader.readAsDataURL(f);
  }
}

function addIngredient() {
  const c = document.getElementById('ingredientsContainer');
  const d = document.createElement('div');
  d.className = 'group';
  d.innerHTML = `
    <input type="text" placeholder="Raw name (vd: 2 qu·∫£ tr·ª©ng)" class="rawName" value="2 qu·∫£ tr·ª©ng" required />
    <input type="number" step="0.1" placeholder="Quantity" class="quantity" value="2" />
    <input type="text" placeholder="Unit (vd: qu·∫£, gram)" class="unit" value="qu·∫£" />
    <input type="number" placeholder="Ingredient ID (n·∫øu c√≥)" class="ingredientId" />
    <input type="number" placeholder="Display order" class="displayOrder" value="1" />
    <button type="button" class="small-btn" onclick="this.parentElement.remove()">X√≥a</button>
  `;
  c.appendChild(d);
}

function addCategory() {
  const c = document.getElementById('categoriesContainer');
  const d = document.createElement('div');
  d.innerHTML = `<input type="number" class="categoryId" placeholder="Category ID" value="1" /> 
                 <button type="button" class="small-btn" onclick="this.parentElement.remove()">X</button>`;
  c.appendChild(d);
}

function addTag() {
  const c = document.getElementById('tagsContainer');
  const d = document.createElement('div');
  d.innerHTML = `<input type="number" class="tagId" placeholder="Tag ID" value="2" /> 
                 <button type="button" class="small-btn" onclick="this.parentElement.remove()">X</button>`;
  c.appendChild(d);
}

document.getElementById('recipeForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const jwt = document.getElementById('jwt').value.trim();
  if (!jwt) return alert('‚ö†Ô∏è B·∫°n ch∆∞a nh·∫≠p JWT!');

  const form = e.target;
  const formData = new FormData();

  // Basic fields
  ['title','description','servings','prepTime','cookTime','difficulty','scope']
    .forEach(n => {
      const el = form.querySelector(`[name="${n}"]`);
      if (el && el.value) formData.append(n, el.value);
    });

  // Main image
  const image = form.querySelector('input[name="image"]').files[0];
  if (image) formData.append('image', image);

  // Steps
  document.querySelectorAll('#stepsContainer .group').forEach((el, idx) => {
    formData.append(`steps[${idx}].stepNumber`, el.querySelector('.stepNumber').value);
    formData.append(`steps[${idx}].description`, el.querySelector('.stepDesc').value);
    const imgs = el.querySelector('.stepImages').files;
    for (let f of imgs) {
      formData.append(`steps[${idx}].images`, f);
    }
  });

  // Ingredients
  document.querySelectorAll('#ingredientsContainer .group').forEach((el, idx) => {
    formData.append(`recipeIngredients[${idx}].rawName`, el.querySelector('.rawName').value);
    formData.append(`recipeIngredients[${idx}].quantity`, el.querySelector('.quantity').value || '');
    formData.append(`recipeIngredients[${idx}].unit`, el.querySelector('.unit').value || '');
    formData.append(`recipeIngredients[${idx}].ingredientId`, el.querySelector('.ingredientId').value || '');
    formData.append(`recipeIngredients[${idx}].displayOrder`, el.querySelector('.displayOrder').value || '');
  });

  // Categories & Tags
  [...document.querySelectorAll('.categoryId')].map(i => i.value).filter(v => v)
    .forEach((v, i) => formData.append(`categoryIds[${i}]`, v));
  [...document.querySelectorAll('.tagId')].map(i => i.value).filter(v => v)
    .forEach((v, i) => formData.append(`tagIds[${i}]`, v));

  try {
    const res = await fetch('http://localhost:8080/user/create/recipe', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + jwt },
      body: formData
    });

    const rawText = await res.text();
    document.getElementById('result').textContent = `Status: ${res.status}\n` + rawText;
    alert(`üì° Response (${res.status}):\n\n` + rawText);
  } catch (err) {
    const msg = '‚ùå L·ªói: ' + err.message;
    document.getElementById('result').textContent = msg;
    alert(msg);
  }
});

// th√™m s·∫µn 1 step v√† 1 nguy√™n li·ªáu
window.addEventListener('DOMContentLoaded', () => {
  addStep();
  addIngredient();
});
</script>

</body>
</html>
